version: 2.1

# Define the jobs we want to run for this project
jobs:
  lint-test:
    # Primary container image where all commands run
    docker:
      - image: cimg/node:20.0.0

    # service container image
      - image: cimg/mariadb:10.10.3
        name: db
        environment:
          MARIADB_ROOT_PASSWORD: $DB_ROOT_PW
          MARIADB_DATABASE: $DB_NAME
          MARIADB_USER: $DB_USER
          MARIADB_PASSWORD: $DB_PW
    steps:
      - checkout
      - run: 
          name: "Install dependencies"
          command: npm install
      - run:
          name: install dockerize
          command: wget https://github.com/jwilder/dockerize/releases/download/$DOCKERIZE_VERSION/dockerize-linux-amd64-$DOCKERIZE_VERSION.tar.gz && sudo tar -C /usr/local/bin -xzvf dockerize-linux-amd64-$DOCKERIZE_VERSION.tar.gz && rm dockerize-linux-amd64-$DOCKERIZE_VERSION.tar.gz
          environment:
            DOCKERIZE_VERSION: v0.6.1
      - run:
          name: Wait for db
          command: dockerize -wait tcp://db:3306 -timeout 1m
#      - run: 
#          name: connect to db test
#          command: |
#            sudo apt-get update && sudo apt-get install -y mysql-client
#            mysql -h db -u todo-admin -p'admin-pw' -D tododot -e "select * from tododot.users;"
#            exit
      - run:
          name: "Linting"
          command: npm run lint
      - run: 
          name: "Testing"
          command: npm run test

  build:
    docker:
      - image: docker:stable
    steps:
      - checkout
      - setup_remote_docker
      - run: 
          name: "Building"
          command: echo "building docker image ... "

  deliver:
    docker:
      - image: cimg/base:2023.04
    steps:
      - checkout
      - run: 
          name: "Deliver"
          command: echo "deliver stage ..."

  deploy:
    docker:
      - image: cimg/base:2023.04
    steps:
      - checkout
      - run: 
          name: "Deploy"
          command: echo "deploy stage ... "

# Orchestrate our job run sequence
workflows:
  version: 2
  lint-test-build-deliver-deploy:
    jobs:
      - lint-test
      - build:
        requires:
          - lint-test
      - deliver:
        requires:
          - build
      - deploy:
        requires:
          - deliver
